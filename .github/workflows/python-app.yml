name: Python Test Automation with Allure Report

on:
  push:
    branches:
      - pytest-automation
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  test:
    runs-on: [self-hosted, windows]

    env:
      NODE_TLS_REJECT_UNAUTHORIZED: 0
      PATH: C:\Users\Vidya Revankar\AppData\Local\Programs\Python\Python312;%PATH%

    strategy:
      fail-fast: false
      matrix:
        marker: [smoke, regression]

    steps:
      - name: Verify Git is available
        run: git --version
        shell: cmd

      - name: Clone repo
        run: |
          if exist repo rmdir /S /Q repo
          git clone --branch pytest-automation https://github.com/${{ github.repository_owner }}/python-automation.git repo
        shell: cmd

      - name: Verify Python
        run: python --version
        shell: cmd

      - name: Install dependencies + Allure CLI
        run: |
          cd repo
          pip install -r requirements.txt
          pip install allure-pytest
          REM Download Allure CLI
          curl -L -o allure.zip https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip
          tar -xf allure.zip
          setx ALLURE_HOME "%CD%\allure-2.29.0"
          setx PATH "%PATH%;%CD%\allure-2.29.0\bin"
        shell: cmd

      - name: Run pytest for marker
        run: |
          cd repo
          python -m pytest -v -s -m %{{ matrix.marker }} --alluredir=allure-results-%{{ matrix.marker }} || exit 0
        shell: cmd

      - name: Collect Allure results
        run: |
          if not exist merged-results mkdir merged-results
          xcopy /E /I repo\allure-results-* merged-results\
        shell: cmd

  merge-deploy:
    runs-on: [self-hosted, windows]
    needs: test
    if: always()

    steps:
      - name: Clone gh-pages branch
        run: |
          if exist site rmdir /S /Q site
          git clone --branch gh-pages https://github.com/${{ github.repository_owner }}/python-automation.git site
        shell: cmd

      - name: Merge Allure results
        run: |
          mkdir site\allure-results
          xcopy /E /I merged-results\* site\allure-results\
        shell: cmd

      - name: Generate Allure report
        run: |
          cd site
          allure generate allure-results -o reports --clean
        shell: cmd

      - name: Commit & push reports
        run: |
          cd site
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add reports
          git commit -m "Update Allure report"
          git push origin gh-pages
        shell: cmd
