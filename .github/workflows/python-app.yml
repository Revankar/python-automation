name: Python Selenium Test Automation with Allure

on:
  push:
    branches:
      - pytest-automation
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: [self-hosted, windows]

    env:
      PATH: "C:\\Users\\Vidya Revankar\\AppData\\Local\\Programs\\Python\\Python312;%PATH%"
      NODE_TLS_REJECT_UNAUTHORIZED: 0

    strategy:
      fail-fast: false
      matrix:
        marker: [smoke, regression, sanity]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Python
        shell: cmd
        run: python --version

      - name: Install dependencies
        shell: cmd
        run: |
          pip install -r requirements.txt
          pip install allure-pytest selenium webdriver-manager

      - name: Download and extract Allure CLI
        shell: cmd
        run: |
          python - <<END
          import urllib.request, zipfile, os
          url = "https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.zip"
          urllib.request.urlretrieve(url, "allure.zip")
          with zipfile.ZipFile("allure.zip","r") as zip_ref:
              zip_ref.extractall("allure")
          END

      - name: Set ALLURE_HOME
        shell: cmd
        run: |
          set ALLURE_HOME=%CD%\allure\allure-2.29.0
          set PATH=%ALLURE_HOME%\bin;%PATH%

      - name: Run pytest for marker ${{ matrix.marker }}
        shell: cmd
        run: pytest -v -s -m "${{ matrix.marker }}" --alluredir=allure-results-${{ matrix.marker}} || exit 0

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-${{ matrix.marker }}
          path: allure-results-${{ matrix.marker}}

  merge:
    runs-on: [self-hosted, windows]
    needs: test
    if: always()

    steps:
      - name: Checkout gh-pages (if exists)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: existing-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Set Git identity
        shell: cmd
        run: |
          cd existing-pages
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Ensure gh-pages branch exists
        shell: cmd
        run: |
          cd existing-pages
          git show-ref --verify --quiet refs/heads/gh-pages || (
            git checkout --orphan gh-pages
            git commit --allow-empty -m "Initial gh-pages commit"
            git push origin gh-pages
          )

      - name: Checkout full repo
        uses: actions/checkout@v4

      - name: Generate timestamp
        id: ts
        shell: cmd
        run: echo TS=%DATE:~10,4%%DATE:~4,2%%DATE:~7,2%%TIME:~0,2%%TIME:~3,2%%TIME:~6,2%>>%GITHUB_ENV

      - name: Download matrix artifacts
        uses: actions/download-artifact@v4
        with:
          name: allure-smoke
          path: merged-results\smoke
        continue-on-error: true

      - name: Download allure-regression
        uses: actions/download-artifact@v4
        with:
          name: allure-regression
          path: merged-results\regression
        continue-on-error: true

      - name: Download allure-sanity
        uses: actions/download-artifact@v4
        with:
          name: allure-sanity
          path: merged-results\sanity
        continue-on-error: true

      - name: Merge Allure results
        shell: cmd
        run: |
          mkdir allure-results
          if exist merged-results (
            xcopy merged-results\* allure-results /s /e /y
          )
          echo Merged Allure Results:
          dir allure-results /s /b

      - name: Check if any Allure JSON exists
        id: check_json
        shell: cmd
        run: |
          set count=0
          for /r allure-results %%f in (*.json) do set /a count+=1
          echo JSON_COUNT=%count% >> %GITHUB_ENV

      - name: Prepare site folder
        shell: cmd
        run: mkdir site

      - name: Create minimal site if no reports
        if: env.JSON_COUNT == '0'
        shell: cmd
        run: echo ^<html^>^<body^>^<h2^>No reports generated^</h2^>^</body^>^</html^> > site\index.html

      - name: Generate Allure report
        if: env.JSON_COUNT != '0'
        shell: cmd
        run: |
          mkdir site\reports\%TS%
          allure generate allure-results -o site\reports\%TS% --clean
          rmdir /s /q site\latest
          xcopy site\reports\%TS% site\latest /s /e /y

      - name: Generate reports index
        if: env.JSON_COUNT != '0'
        shell: cmd
        run: |
          echo ^<html^>^<body^>^<h1^>All Reports^</h1^>^<ul^> > site\reports\index.html
          for /d %%d in (site\reports\*) do (
            if not "%%~nxd"=="latest" echo ^<li^>^<a href='%%~nxd/'^>Report %%~nxd^</a^>^</li^> >> site\reports\index.html
          )
          echo ^</ul^>^</body^>^</html^> >> site\reports\index.html

      - name: Create root index.html
        shell: cmd
        run: |
          echo ^<html^>^<body^>^<h1^>Allure Reports^</h1^>^<ul^>^<li^>^<a href='./latest/'^>Latest Report^</a^>^</li^>^<li^>^<a href='./reports/'^>All Reports^</a^>^</li^>^</ul^>^</body^>^</html^> > site\index.html

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./site

  deploy:
    needs: merge
    runs-on: [self-hosted, windows]
    environment:
      name: github-pages

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Print Allure URL
        shell: cmd
        run: |
          echo Latest Report:
          echo https://%GITHUB_REPOSITORY_OWNER%.github.io/%GITHUB_REPOSITORY%/latest/
          echo All Reports:
          echo https://%GITHUB_REPOSITORY_OWNER%.github.io/%GITHUB_REPOSITORY%/reports/
